{% extends "base.html" %}

{% block content %}
<section class="fund-section py-5">
  <div class="fund-wrapper">
    <!-- Left side: Fund Explanation -->
    <div class="fund-info">
      <h2 class="fw-bold mb-4">Vega Core Fund</h2>
      
      <div class="fund-details">
        <h4>Investment Strategy</h4>
        <p class="text-muted mb-4 text-justify">
           
                Our flagship fund employs a disciplined futures-based strategy designed to smooth volatility 
          and mitigate the impact of margin call–induced deleveraging. Applied primarily in the gold futures market,
           this approach has delivered consistent, upward-trending returns with significantly lower drawdowns than
            major domestic benchmarks such as the Iranian stock market, the Rial–Dollar exchange rate, and spot gold.
             As shown, the Fund has outperformed these comparators both in absolute terms and in stability, maintaining
              a steady growth path through varying market conditions. This makes it well-suited for investors seeking
               long-term capital preservation with moderate, compounding returns, particularly those wishing to reduce
                exposure to sharp local macroeconomic shocks while retaining participation in commodity market upside.
            </p>
          
        </p>

        <h4>Key Features</h4>
        <ul class="list-unstyled">
          <li class="mb-2">
            <strong>Focus:</strong> Future Market
          </li>
          <li class="mb-2">
            <strong>Strategy:</strong> Volatility-Managed Calendar Spread
          </li>
          <li class="mb-2">
            <strong>Minimum Investment:</strong> $5000
          </li>
          <li class="mb-2">
            <strong>Management Fee:</strong> 2% annually
          </li>
          <li class="mb-2">
            <strong>Performance Fee:</strong> 25% of profits above 40% hurdle
          </li>
        </ul>

        <h4>Performance Metrics</h4>
        <div class="metrics-grid">
          <div class="metric-item">
            <span class="metric-label">Annualized performance from inception:</span>
            <span class="metric-value text-success">+48.77%</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Sharpe Ratio:</span>
            <span class="metric-value">1.85</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Max Drawdown:</span>
            <span class="metric-value text-danger">-4.2%</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Volatility:</span>
            <span class="metric-value">8.7%</span>
          </div>
        </div>

        <div class="mt-4">
          <a href="{{ url_for('login') }}" class="btn btn-dark me-3">Access Detailed Reports</a>
          <button class="btn btn-outline-dark">Download Fact Sheet</button>
        </div>
      </div>
    </div>

    <!-- Right side: Interactive Chart -->
    <div class="chart-container">
      <div class="chart-controls mb-3">
        <div class="row">
          <div class="col-md-4">
            <label for="startDate" class="form-label">Start Date:</label>
            <input type="date" id="startDate" class="form-control" />
          </div>
          <div class="col-md-4">
            <label for="endDate" class="form-label">End Date:</label>
            <input type="date" id="endDate" class="form-control" />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="updateChart" class="btn btn-primary">Update Chart</button>
          </div>
        </div>
      </div>
      <div class="chart-area">
        <canvas id="fundChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Second row -->
  <div class="fund-wrapper">
    <div class="fund-info">
        ... text & metrics for Fund 2 ...
    </div>
    <div class="chart-container">
        ... chart for Fund 2 ...
    </div>
</div>
 

</section>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>



<script>
let fundChart;
let csvRows = [];             // [{ date:'YYYY-MM-DD', series: {Fund: number|null, Dollar: ..., Firouzeh: ..., Gold: ...} }]
let seriesNames = [];         // ['Fund','Dollar','Firouzeh','Gold']

/* ---------- Helpers ---------- */

// Detect delimiter from header
function detectDelimiter(headerLine) {
  const cands = [',',';','\t','|'];
  let best = ',', bestCount = 0;
  for (const d of cands) {
    const c = headerLine.split(d).length - 1;
    if (c > bestCount) { best = d; bestCount = c; }
  }
  return best;
}

// Robust numeric parser. If a % was present, convert to decimal.
function parseNumber(s) {
  if (s == null) return NaN;
  s = String(s).trim().replace(/^\uFEFF/, '').replace(/\u00A0/g, '');
  let hadPercent = /%/.test(s);
  s = s.replace(/%/g, '');

  const hasComma = s.includes(','), hasDot = s.includes('.');
  if (hasComma && hasDot) {
    if (s.lastIndexOf(',') > s.lastIndexOf('.')) s = s.replace(/\./g,'').replace(',', '.');
    else s = s.replace(/,/g,'');
  } else if (hasComma) {
    s = s.replace(',', '.');
  }
  let v = parseFloat(s);
  if (!isFinite(v)) return NaN;
  if (hadPercent) v = v / 100;
  return v;
}

// Parse CSV to {date, series:{}}, auto-detect numeric columns (excluding date)
function parseCSVMulti(csvText) {
  const lines = csvText
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(l => l.length > 0);
  if (lines.length < 2) throw new Error('CSV appears empty');

  const headerRaw = lines[0].replace(/^\uFEFF/, '');
  const delim = detectDelimiter(headerRaw);
  const headerCells = headerRaw.split(delim).map(h => h.trim());

  // Find date column (case-insensitive)
  const lower = headerCells.map(h => h.toLowerCase());
  const dateIdx = lower.findIndex(h => ['date','timestamp','day','nav_date'].includes(h));
  const dateCol = dateIdx >= 0 ? dateIdx : 0;

  // Determine series columns = all except date
  const seriesCols = headerCells
    .map((name, idx) => ({ name: name.trim(), idx }))
    .filter(col => col.idx !== dateCol);

  // Normalize pretty names (preserve original case)
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(delim);
    if (parts.length <= dateCol) continue;

    const dRaw = parts[dateCol]?.trim();
    if (!dRaw) continue;

    const dt = new Date(dRaw);
    const iso = isNaN(dt.getTime()) ? dRaw : dt.toISOString().split('T')[0];

    const rec = { date: iso, series: {} };
    for (const col of seriesCols) {
      const cell = parts[col.idx] != null ? parts[col.idx] : '';
      const v = parseNumber(cell);
      rec.series[col.name] = isFinite(v) ? v : null;
    }
    rows.push(rec);
  }

  // Sort by date asc
  rows.sort((a,b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));

  return {
    rows,
    names: seriesCols.map(c => c.name)
  };
}

// Get first non-null numeric in array
function firstValid(arr) {
  for (const x of arr) {
    if (x != null && isFinite(x)) return x;
  }
  return null;
}

/* ---------- Data Loading ---------- */

async function loadCSVData() {
  try {
    const resp = await fetch('{{ url_for("static", filename="fund_data.csv") }}', { cache: 'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const text = await resp.text();

    const parsed = parseCSVMulti(text);
    csvRows = parsed.rows;
    seriesNames = parsed.names;

    if (!csvRows.length || !seriesNames.length) throw new Error('No usable data/series found');

    // Init date pickers to full range
    document.getElementById('startDate').value = csvRows[0].date;
    document.getElementById('endDate').value   = csvRows[csvRows.length - 1].date;

    updateChart();
  } catch (err) {
    console.error('Error loading/parsing CSV:', err);
    alert('Could not read /static/fund_data.csv. Check delimiter/headers and number formats.');
  }
}

/* ---------- Filtering & Chart ---------- */

function filterByDate(startDate, endDate) {
  const s = new Date(startDate);
  const e = new Date(endDate);
  if (isNaN(s) || isNaN(e)) return [];
  return csvRows.filter(r => {
    const t = new Date(r.date);
    return !isNaN(t) && t >= s && t <= e;
  });
}

function rebaseSeries(values) {
  // values: array of numbers or nulls within selected window
  const base = firstValid(values);
  if (base == null || !isFinite(base) || base <= -1) return values.map(_ => null);
  return values.map(v => (v == null || !isFinite(v)) ? null : (((1 + v) / (1 + base)) - 1) * 100);
}

function updateChart() {
  const startDate = document.getElementById('startDate').value;
  const endDate   = document.getElementById('endDate').value;
  if (!startDate || !endDate || !csvRows.length) return;

  const rows = filterByDate(startDate, endDate);
  if (!rows.length) {
    console.warn('No data in selected range');
    return;
  }

  const labels = rows.map(r => r.date);

  // Build datasets for each series
  const datasets = [];
  const palette = [
    '#0d6efd', // blue
    '#dc3545', // red
    '#198754', // green
    '#fd7e14', // orange
    '#6f42c1', // purple
    '#20c997', // teal
  ];

  seriesNames.forEach((name, i) => {
    // Extract raw values for this series in window
    const raw = rows.map(r => r.series[name]);
    const rebasedPct = rebaseSeries(raw);

    datasets.push({
      label: name,
      data: rebasedPct,
      borderWidth: 0.5,
      tension: 0.1,
      borderColor: palette[i % palette.length],
      backgroundColor: 'rgba(0,0,0,0)', // no fill; change if you want area
      spanGaps: true,                   // skip nulls nicely
      pointRadius: 0.5,          // removes the circles
      pointHoverRadius: 0.5      // removes them even on hover
    });
  });

  const ctx = document.getElementById('fundChart').getContext('2d');
  if (fundChart) fundChart.destroy();

  fundChart = new Chart(ctx, {
  type: 'line',
  data: { labels, datasets },
  options: {
    responsive: true,
    maintainAspectRatio: false, // This is the key change!
    scales: {
      x: { title: { display: true, text: 'Date' } },
      y: {
        title: { display: true, text: 'Return since start (%)' },
        ticks: { callback: v => v.toFixed(1) + '%' }
      }
    },
    plugins: {
      title: { display: true, text: 'Vega Core Fund — Rebased Performance (Selected Window)' },
      legend: { display: true, position: 'top' },
      tooltip: {
        callbacks: {
          label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y != null ? ctx.parsed.y.toFixed(2) + '%' : '—'}`
        }
      }
    }
  }
  });
}

/* ---------- Events ---------- */
['startDate','endDate'].forEach(id =>
  document.getElementById(id).addEventListener('change', updateChart)
);
document.getElementById('updateChart').addEventListener('click', updateChart);
window.addEventListener('load', loadCSVData);
</script>

{% endblock %}    