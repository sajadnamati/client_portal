{% extends "base.html" %}

{% block content %}
<section class="fund-section py-5">
  <div class="fund-wrapper">
    <!-- Left side: Fund Explanation -->
    <div class="fund-info">
      <h2 class="fw-bold mb-4">Vega Core Fund</h2>
      
      <div class="fund-details">
        <h4>Investment Strategy</h4>
        <p class="text-muted mb-4">
          Our flagship fund employs a quantitative approach to energy and commodity markets, 
          leveraging proprietary models to identify asymmetric risk-adjusted opportunities. 
          Through systematic analysis and disciplined execution, we aim to deliver consistent 
          returns while managing downside risk.
        </p>

        <h4>Key Features</h4>
        <ul class="list-unstyled">
          <li class="mb-2">
            <strong>Focus:</strong> Energy markets and related sectors
          </li>
          <li class="mb-2">
            <strong>Strategy:</strong> Quantitative value with risk management overlay
          </li>
          <li class="mb-2">
            <strong>Minimum Investment:</strong> $500,000
          </li>
          <li class="mb-2">
            <strong>Management Fee:</strong> 1.5% annually
          </li>
          <li class="mb-2">
            <strong>Performance Fee:</strong> 20% of profits above 8% hurdle
          </li>
        </ul>

        <h4>Performance Metrics</h4>
        <div class="metrics-grid">
          <div class="metric-item">
            <span class="metric-label">YTD Return:</span>
            <span class="metric-value text-success">+12.4%</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Sharpe Ratio:</span>
            <span class="metric-value">1.85</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Max Drawdown:</span>
            <span class="metric-value text-danger">-4.2%</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Volatility:</span>
            <span class="metric-value">8.7%</span>
          </div>
        </div>

        <div class="mt-4">
          <a href="{{ url_for('login') }}" class="btn btn-dark me-3">Access Detailed Reports</a>
          <button class="btn btn-outline-dark">Download Fact Sheet</button>
        </div>
      </div>
    </div>

    <!-- Right side: Interactive Chart -->
    <div class="chart-container">
      <div class="chart-controls mb-3">
        <div class="row">
          <div class="col-md-4">
            <label for="startDate" class="form-label">Start Date:</label>
            <input type="date" id="startDate" class="form-control" />
          </div>
          <div class="col-md-4">
            <label for="endDate" class="form-label">End Date:</label>
            <input type="date" id="endDate" class="form-control" />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="updateChart" class="btn btn-primary">Update Chart</button>
          </div>
        </div>
      </div>
      <div class="chart-area">
        <canvas id="fundChart" width="100%" height="400"></canvas>
      </div>
    </div>
  </div>
</section>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
let fundChart;
let csvData = []; // [{date: 'YYYY-MM-DD', value: Number}]

/* ---------- Helpers ---------- */

// Detect the delimiter likely used by the header line
function detectDelimiter(headerLine) {
  const candidates = [',', ';', '\t', '|'];
  let best = ',', bestCount = 0;
  for (const d of candidates) {
    const c = headerLine.split(d).length - 1;
    if (c > bestCount) { best = d; bestCount = c; }
  }
  return best;
}

// Robust numeric parser: handles %, thousands, decimal comma, NBSP, BOM, etc.
function parseNumber(s) {
  if (s == null) return NaN;
  s = String(s).trim()
    .replace(/^\uFEFF/, '')          // BOM
    .replace(/\u00A0/g, '');         // NBSP

  // Remove percent but remember to scale if needed later (not needed now; we plot raw)
  const hadPercent = /%/.test(s);
  s = s.replace(/%/g, '');

  const hasComma = s.includes(',');
  const hasDot = s.includes('.');

  if (hasComma && hasDot) {
    // If last separator is a comma, treat comma as decimal and dots as thousands
    if (s.lastIndexOf(',') > s.lastIndexOf('.')) {
      s = s.replace(/\./g, '').replace(',', '.');
    } else {
      // last is dot -> dot is decimal, commas are thousands
      s = s.replace(/,/g, '');
    }
  } else if (hasComma && !hasDot) {
    // Only comma present: assume decimal comma
    s = s.replace(',', '.');
  } else {
    // Only dot or neither: remove any thousands commas just in case
    s = s.replace(/,/g, '');
  }

  let v = parseFloat(s);
  if (!isFinite(v)) return NaN;

  // If it had a percent sign and the value looks like e.g. "12.3", many exports mean 12.3%
  // We are plotting RAW to match CSV visually; keep it as-is (no scaling).
  return v;
}

// Parse CSV text into [{date, value}]
function parseCSV(csvText) {
  const lines = csvText
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(l => l.length > 0);

  if (lines.length < 2) throw new Error('CSV appears empty');

  const header = lines[0].replace(/^\uFEFF/, ''); // strip BOM if present
  const delim = detectDelimiter(header);
  const headers = header.split(delim).map(h => h.trim().toLowerCase());

  // Look for typical date + value/return/nav columns
  const dateIdx = headers.findIndex(h =>
    ['date','timestamp','day','nav_date'].includes(h)
  );
  let valIdx = headers.findIndex(h =>
    ['value','return','cumulative_return','cum_return','nav','index','y'].includes(h)
  );

  // Fallback: if not found, assume first two columns are date, value
  const dateCol = dateIdx >= 0 ? dateIdx : 0;
  const valueCol = valIdx >= 0 ? valIdx : 1;

  const out = [];
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(delim);
    if (parts.length <= Math.max(dateCol, valueCol)) continue;

    const d = parts[dateCol].trim();
    const v = parseNumber(parts[valueCol]);
    if (!d || !isFinite(v)) continue;

    // Normalize date to YYYY-MM-DD if possible
    const dt = new Date(d);
    const iso = isNaN(dt.getTime()) ? d : dt.toISOString().split('T')[0];

    out.push({ date: iso, value: v });
  }

  // Sort by date just in case
  out.sort((a, b) => (a.date < b.date ? -1 : a.date > b.date ? 1 : 0));
  return out;
}

/* ---------- Data Loading ---------- */

async function loadCSVData() {
  try {
    const response = await fetch('/static/fund_data.csv', { cache: 'no-store' });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const csvText = await response.text();

    csvData = parseCSV(csvText);

    if (csvData.length === 0) throw new Error('No usable rows parsed');

    // Initialize the date pickers to full range
    document.getElementById('startDate').value = csvData[0].date;
    document.getElementById('endDate').value   = csvData[csvData.length - 1].date;

    console.log('CSV parsed:', {
      rows: csvData.length,
      first3: csvData.slice(0,3),
      last3: csvData.slice(-3)
    });

    updateChart();
  } catch (err) {
    console.error('Error loading/parsing CSV:', err);
    alert('Could not read /static/fund_data.csv. Check delimiter, decimals, and headers.');
  }
}

/* ---------- Filtering & Chart ---------- */

function filterDataByDateRange(startDate, endDate) {
  const s = new Date(startDate);
  const e = new Date(endDate);
  if (isNaN(s) || isNaN(e)) return [];
  return csvData.filter(item => {
    const t = new Date(item.date);
    return !isNaN(t) && t >= s && t <= e;
  });
}

function updateChart() {
  const startDate = document.getElementById('startDate').value;
  const endDate   = document.getElementById('endDate').value;
  if (!startDate || !endDate || csvData.length === 0) return;

  const filtered = filterDataByDateRange(startDate, endDate);
  if (filtered.length === 0) {
    console.warn('No data in selected range');
    return;
  }

  const labels = filtered.map(d => d.date);
  const series = filtered.map(d => d.value); // cumulative return in decimal, e.g., 0.02 = +2%

  // Rebase: ((1 + R_t) / (1 + R_start)) - 1
  const base = series[0];
  if (!isFinite(base) || base <= -1) {
    console.warn('Invalid base for rebasing'); 
    return;
  }
  const pctValues = series.map(v => (((1 + v) / (1 + base)) - 1) * 100);

  const ctx = document.getElementById('fundChart').getContext('2d');
  if (fundChart) fundChart.destroy();

  fundChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Return since start (%)',
        data: pctValues,
        borderWidth: 2,
        fill: true,
        tension: 0.1,
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { title: { display: true, text: 'Date' } },
        y: {
          title: { display: true, text: 'Return since start (%)' },
          ticks: { callback: v => v.toFixed(1) + '%' }
        }
      },
      plugins: {
        title: { display: true, text: 'Vega Core Fund â€” Period Return (Rebased)' },
        legend: { display: true, position: 'top' }
      }
    }
  });
}
/* ---------- Events ---------- */
document.getElementById('updateChart').addEventListener('click', updateChart);
window.addEventListener('load', loadCSVData);
</script>

{% endblock %}    