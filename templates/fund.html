{% extends "base.html" %}

{% block content %}
<section class="fund-section py-5">
  <div class="fund-wrapper">
    <!-- Left side: Fund Explanation -->
    <div class="fund-info">
      <h2 class="fw-bold mb-4">Vega Core Fund</h2>
      
      <div class="fund-details">
        <h4>Investment Strategy</h4>
        <p class="text-muted mb-4 text-justify">
          Our flagship fund employs a disciplined futures-based strategy designed to smooth volatility 
          and mitigate the impact of margin call–induced deleveraging. Applied primarily in the gold futures market,
          this approach has delivered consistent, upward-trending returns with significantly lower drawdowns than
          major domestic benchmarks such as the Iranian stock market, the Rial–Dollar exchange rate, and spot gold.
          As shown, the Fund has outperformed these comparators both in absolute terms and in stability, maintaining
          a steady growth path through varying market conditions. This makes it well-suited for investors seeking
          long-term capital preservation with moderate, compounding returns, particularly those wishing to reduce
          exposure to sharp local macroeconomic shocks while retaining participation in commodity market upside.
        </p>

        <h4>Key Features</h4>
        <ul class="list-unstyled">
          <li class="mb-2"><strong>Focus:</strong> Future Market</li>
          <li class="mb-2"><strong>Strategy:</strong> Volatility-Managed Calendar Spread</li>
          <li class="mb-2"><strong>Minimum Investment:</strong> $5000</li>
          <li class="mb-2"><strong>Management Fee:</strong> 2% annually</li>
          <li class="mb-2"><strong>Performance Fee:</strong> 25% of profits above 50% hurdle</li>
        </ul>

        <h4>Performance Metrics</h4>
          <div class="metrics-grid">
            <div class="metric-item">
              <span class="metric-label">YTD Fund Return (Before Fees):</span>
              <span id="ytdReturn" class="metric-value text-success">—</span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Locked-in Return:</span>
              <span id="lockedInReturn" class="metric-value">—</span>
            </div>
          </div>
      </div>
    </div>

    <!-- Right side: Interactive Chart -->
    <div class="chart-container">
      <h4>Performance Chart</h4>
      <div class="chart-controls mb-3">
        <div class="row">
          <div class="col-md-4">
            <label for="startDate" class="form-label">Start Date:</label>
            <input type="date" id="startDate" class="form-control" />
          </div>
          <div class="col-md-4">
            <label for="endDate" class="form-label">End Date:</label>
            <input type="date" id="endDate" class="form-control" />
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button id="updateChart" class="btn btn-primary">Update</button>

            <!-- Series dropdown, same pattern as code 1 -->
            <div class="btn-group ms-2">
              <button id="seriesToggle"
                      class="btn btn-outline-secondary dropdown-toggle"
                      data-bs-toggle="dropdown"
                      aria-expanded="false">
                Indices
              </button>
              <div id="seriesMenu" class="dropdown-menu p-3" style="min-width:260px; max-height:300px; overflow:auto;">
                <div class="d-flex justify-content-between mb-2">
                  <button id="seriesSelectAll" type="button" class="btn btn-sm btn-link">Select all</button>
                  <button id="seriesSelectNone" type="button" class="btn btn-sm btn-link">None</button>
                </div>
                <div id="seriesControls"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="chart-area">
        <canvas id="fundChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Second row: Compensation Structure -->
  <div class="fund-wrapper">
    <!-- Left side: text -->
    <div class="fund-info">
      <h4 data-bs-toggle="collapse" data-bs-target="#compChartCollapse" style="cursor:pointer;">
        Compensation Structure
      </h4>
      <div class="collapse" id="compChartCollapse">
        <p class="text-muted text-justify mt-3">
          Our compensation model is designed to align the interests of the fund manager with those of our investors,
          ensuring that meaningful rewards are earned only when we generate exceptional value. The cornerstone of this
          philosophy is the <strong>hurdle rate</strong> — a predefined minimum return threshold that must be achieved
          before any performance fees are charged. By setting a high hurdle rate, in our case 40% annually, we create a
          results-driven environment that rewards strategic risk-taking and disciplined execution, while protecting
          investors from paying performance fees during periods of sub-par market conditions. This approach ensures that
          we only participate in profits that represent substantial outperformance beyond the already ambitious benchmark.

        </p>

        <div class="mt-4">
          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Fixed Management Fee<span>2% annually *</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Hurdle Rate<span>50% annually *</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Manager’s Share of Return Above Hurdle<span>25% *</span>
            </li>
          </ul>
        </div>

        <p class="small text-muted mt-3">
          * All parameters are subject to change based on prevailing market conditions, regulatory updates,
          and the fund’s strategic objectives. Any such changes will be communicated to investors in advance.

        </p>
      </div>
    </div>

    <!-- Right side: chart -->
    <div class="chart-container">
      <div id="compChartCollapse" class="collapse">
        <div class="chart-area" style="height:400px;">
          <canvas id="compensationChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Chart.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<script>
let fundChart;
let csvRows = [];
let seriesNames = [];
const EXTRA_SERIES_KEY = "Fund (After Fee)";
let selectedSeries = new Set();

let fundPayload;

/** Fetch rebased series from Python backend */
async function loadFundSeries(startStr, endStr) {
  const url = `/api/public-fund-series?start=${encodeURIComponent(startStr)}&end=${encodeURIComponent(endStr)}`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error(`API error ${r.status}`);
  fundPayload = await r.json();

  seriesNames = fundPayload.series_names || [];
  if (selectedSeries.size === 0) {
    seriesNames.forEach(s => selectedSeries.add(s)); // select all initially
  }
  renderSeriesControls();
}

/** Render dropdown checkboxes */
function renderSeriesControls() {
  const container = document.getElementById('seriesControls');
  if (!container) return;

  const allSeries = [...seriesNames];
  container.innerHTML = '';

  allSeries.forEach((name, idx) => {
    const id = `series-${idx}`;
    const row = document.createElement('div');
    row.className = 'form-check mb-1';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'form-check-input';
    cb.id = id;
    cb.checked = selectedSeries.has(name);
    cb.addEventListener('change', () => {
      if (cb.checked) selectedSeries.add(name);
      else selectedSeries.delete(name);
      updateChart();
    });

    const label = document.createElement('label');
    label.className = 'form-check-label';
    label.setAttribute('for', id);
    label.textContent = name;

    row.appendChild(cb);
    row.appendChild(label);
    container.appendChild(row);
  });

  // "Select all / none" buttons
  const btnAll  = document.getElementById('seriesSelectAll');
  const btnNone = document.getElementById('seriesSelectNone');
  if (btnAll) btnAll.onclick = () => { selectedSeries = new Set(allSeries); renderSeriesControls(); updateChart(); };
  if (btnNone) btnNone.onclick = () => { selectedSeries.clear(); renderSeriesControls(); updateChart(); };
}

/** Draw chart from fundPayload */
function updateChart() {
  if (!fundPayload || !Array.isArray(fundPayload.dates)) return;

  const labels = fundPayload.dates;
  const datasets = [];
  const palette = ['#0d6efd','#dc3545','#198754','#fd7e14','#6f42c1','#20c997'];

  seriesNames.forEach((name, i) => {
    if (!selectedSeries.has(name)) return;
    const matrix = fundPayload.series_matrix || [];
    const arr = Array.isArray(matrix[i]) ? matrix[i] : [];
    datasets.push({
      label: name,
      data: arr.map(v => (v == null ? null : v * 100)),
      borderWidth: 0.8,
      tension: 0.1,
      borderColor: palette[datasets.length % palette.length],
      backgroundColor: 'rgba(0,0,0,0)',
      spanGaps: true,
      pointRadius: 0.6,
      pointHoverRadius: 1
    });
  });

  const ctx = document.getElementById('fundChart').getContext('2d');
  if (fundChart) fundChart.destroy();
  fundChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { title: { display: true, text: 'Date' } },
        y: {
          title: { display: true, text: 'Return since start (%)' },
          ticks: { callback: v => (v ?? 0).toFixed(1) + '%' }
        }
      },
      plugins: {
        title: { display: true, text: 'Vega Core Fund — Rebased Performance (Selected Window)' },
        legend: { display: true, position: 'top' },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y != null ? ctx.parsed.y.toFixed(2) + '%' : '—'}`
          }
        }
      }
    }
  });
}

/** Initial load + event bindings */
document.addEventListener('DOMContentLoaded', async () => {
  const today = new Date();
  const todayStr = today.toISOString().split('T')[0];

  // First load full range (backend will default start if not given)
  await loadFundSeries("2020-10-17", todayStr);

  // Prefill inputs
  document.getElementById("startDate").value = "2020-10-17";
  document.getElementById("endDate").value   = todayStr;

  updateChart();

  // Bind "Update" button
  document.getElementById('updateChart').addEventListener('click', async () => {
    const startStr = document.getElementById('startDate').value;
    const endStr   = document.getElementById('endDate').value;
    if (!startStr || !endStr) {
      alert("Please pick both start and end dates");
      return;
    }
    await loadFundSeries(startStr, endStr);
    updateChart();
  });
});


</script>

<script>
async function loadFundMetrics() {
  try {
    const resp = await fetch("/api/public-fund-metrics", { cache: "no-store" });
    if (!resp.ok) throw new Error(`API error ${resp.status}`);
    const data = await resp.json();

    // Format as %
    const fmt = (v) => (v != null ? (v * 100).toFixed(2) + "%" : "—");

    document.getElementById("ytdReturn").textContent = fmt(data.ytd_return);
    document.getElementById("lockedInReturn").textContent = fmt(data.locked_in_return);
  } catch (e) {
    console.error("Failed to load metrics:", e);
  }
}

document.addEventListener("DOMContentLoaded", loadFundMetrics);
</script>











<script>
document.addEventListener('DOMContentLoaded', () => {
  const compCanvas = document.getElementById('compensationChart');
  const compChartCollapse = document.getElementById('compChartCollapse');

  compChartCollapse.addEventListener('shown.bs.collapse', async () => {
    if (compCanvas.dataset.loaded) return; // only load once
    try {
      const resp = await fetch("/api/public-compensation-chart", { cache: "no-store" });
      const payload = await resp.json();

      const labels = payload.Ret.map(v => v.toFixed(0) + "%");
      const investorReturn = payload.Investor;
      const fundFee = payload.Fund;

      new Chart(compCanvas.getContext('2d'), {
        type: 'bar',
        data: { labels,
          datasets: [
            { label: 'Investor Return', data: investorReturn,
              backgroundColor: 'rgba(54, 162, 235, 0.7)', stack: 'combined' },
            { label: 'Fund Fee', data: fundFee,
              backgroundColor: 'rgba(255, 159, 64, 0.7)', stack: 'combined' }
          ]},
        options: { responsive: true, maintainAspectRatio: false,
          scales: { x: { stacked:true, title:{display:true,text:'Total Return'} },
                    y: { stacked:true, beginAtZero:true, ticks:{callback:v=>v+'%'} } },
          plugins: { legend:{position:'top'},
            title:{display:true,text:'Compensation vs Investor Return (Stacked)'} }
        }
      });
      compCanvas.dataset.loaded = "true";
    } catch(e) { console.error("Comp chart failed", e); }
  });
});
</script>
{% endblock %}
